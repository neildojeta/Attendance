{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Event Dashboard</title>

  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="{% static 'myapp/admin.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Inline Styles -->
  <style>
    /* === Base Layout === */
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
    }

    .main-wrapper {
      margin-left: 100px;
      padding: 40px;
      width: calc(100% - 150px);
    }

    .dashboard-container {
      padding: 30px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    h1 {
      margin-bottom: 20px;
    }

    /* === Buttons === */
    .btn {
      background-color: #b30000;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    .btn:hover {
      background-color: #990000;
    }

    /* === Event Display === */
    .event-display {
      margin-top: 20px;
      background: #fff7e6;
      border: 1px solid #ffcc80;
      padding: 15px;
      border-radius: 10px;
    }

    /* === Calendar Styles === */
    .calendar-section {
      margin-top: 30px;
    }

    .calendar {
      border: 1px solid #ccc;
      border-radius: 10px;
      overflow: hidden;
    }

    .month {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: crimson;
      color: white;
    }

    .month button {
      background: transparent;
      border: none;
      font-size: 24px;
      color: white;
      cursor: pointer;
    }

    .weekdays, .days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
    }

    .weekdays div {
      padding: 10px 0;
      background: #eee;
      font-weight: 600;
    }

    .days div {
      padding: 15px 0;
      cursor: pointer;
      transition: 0.3s;
      color: black;
    }

    .days div.highlighted {
      background-color: gold;
      color: crimson;
      border-radius: 50%;
      font-weight: bold;
    }

    .days div.today {
      border-bottom: 3px solid red;
    }

    /* === Popup Form === */
    .popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .popup-content {
      background: white;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
    }

    .popup-content input,
    .popup-content select {
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    .popup-content .btn-row {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }

    .popup-content .btn-row .btn {
      flex: 1;
      margin: 0 5px;
    }

    /* === Table Section === */
    .table-title {
      font-size: 1.5em;
      font-weight: bold;
      margin-top: 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .search-bar {
      display: flex;
      gap: 10px;
    }

    .search-bar input[type="text"] {
      padding: 5px 10px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .search-bar button {
      padding: 6px 12px;
      font-size: 1em;
      background-color: #007BFF;
      border: none;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }

    .search-bar button:hover {
      background-color: #0056b3;
    }

    .scrollable-table {
      max-height: 300px;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 10px;
    }

    table.styled-table {
      width: 100%;
      border-collapse: collapse;
    }

    table.styled-table thead {
      position: sticky;
      top: 0;
      background-color: crimson;
      color: white;
    }

    table.styled-table th, table.styled-table td {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }

    .action-icons i {
      margin-right: 10px;
      cursor: pointer;
      color: #333;
    }

    .action-icons i:hover {
      color: #007BFF;
    }
  </style>
</head>

<body>

  <!-- Main Wrapper -->
  <div class="main-wrapper">
    <div class="dashboard-container">
      <h1>Event Dashboard</h1>
      <button class="btn" onclick="showPopup()">Add Event</button>

      <div class="event-display" id="eventDisplay">
        <strong>No event added yet.</strong>
      </div>

      <!-- Calendar -->
      <div class="calendar-section">
        <div class="calendar">
          <div class="month">
            <button id="prev">&#10094;</button>
            <h2 id="month-year"></h2>
            <button id="next">&#10095;</button>
          </div>
          <div class="weekdays">
            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
          </div>
          <div class="days" id="calendar-days"></div>
        </div>
      </div>
    </div>

    <!-- Event Table -->
    <div class="table-title">
      Event Records
      <div class="search-bar">
        <input type="text" id="search-event" placeholder="Search fields">
      </div>
    </div>

    <div class="scrollable-table">
      <table class="styled-table">
        <thead>
          <tr>
            <th>Event ID</th>
            <th>Event Name</th>
            <th>Venue</th>
            <th>Event Day(s)</th>
            <th>Time Start</th>
            <th>Time End</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="eventTableBody">
          {% for event in events %}
          <tr>
            <td>{{ event.0 }}</td>
            <td>{{ event.1 }}</td>
            <td>{{ event.2 }}</td>
            <td>{{ event.3 }}</td>
            <td>{{ event.4 }}</td>
            <td>{{ event.5 }}</td>
            <td>{{ event.6 }}</td>
            <td class="action-icons">
              <i class="fas fa-edit" title="Edit"></i>
              <i class="fas fa-trash-alt" title="Delete" onclick="confirmEventDelete('{{ event.0 }}')"></i>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8">No event records found.</td>
          </tr>
          {% endfor %}
        </tbody>

      </table>
    </div>
  </div>

  <!-- Popup Modal -->
  <div class="popup" id="popup">
    <div class="popup-content">
      <h3>Add New Event</h3>
      <input type="text" id="event-id" placeholder="Event ID" />
      <input type="text" id="event-name" placeholder="Event Name" />
      <input type="text" id="event-venue" placeholder="Venue" />
      <input type="text" id="event-days" placeholder="Event Day(s)" />
      <input type="time" id="event-start" />
      <input type="time" id="event-end" />
      <input type="date" id="event-date" />
      <div class="btn-row">
        <button class="btn" onclick="addEvent()">Create</button>
        <button class="btn" onclick="hidePopup()" style="background-color: gray;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    const popup = document.getElementById('popup');
    const calendarDays = document.getElementById("calendar-days");
    const monthYear = document.getElementById("month-year");
    const prevBtn = document.getElementById("prev");
    const nextBtn = document.getElementById("next");
    let highlightedDates = [];
    let currentDate = new Date();

    function showPopup() {
      popup.style.display = 'flex';
    }

    function hidePopup() {
      popup.style.display = 'none';
    }

    function confirmEventDelete(id) {
      alert('Delete event with ID: ' + id);
    }

    function addEvent() {
      const eventId = document.getElementById('event-id').value;
      const eventName = document.getElementById('event-name').value;
      const eventVenue = document.getElementById('event-venue').value;
      const eventDays = document.getElementById('event-days').value;
      const eventStart = document.getElementById('event-start').value;
      const eventEnd = document.getElementById('event-end').value;
      const eventDate = document.getElementById('event-date').value;

      if (!eventId || !eventName || !eventVenue || !eventDays || !eventStart || !eventEnd || !eventDate) {
        alert('Please fill in all fields.');
        return;
      }

      const tbody = document.getElementById('eventTableBody');
      const row = document.createElement('tr');

      row.innerHTML = `
        <td>${eventId}</td>
        <td>${eventName}</td>
        <td>${eventVenue}</td>
        <td>${eventDays}</td>
        <td>${eventStart}</td>
        <td>${eventEnd}</td>
        <td>${eventDate}</td>
        <td class="action-icons">
          <i class="fas fa-edit" title="Edit"></i>
          <i class="fas fa-trash-alt" title="Delete" onclick="confirmEventDelete('${eventId}')"></i>
        </td>
      `;

      tbody.appendChild(row);
      highlightedDates.push(eventDate);
      renderCalendar(currentDate);
      hidePopup();
    }

    function renderCalendar(date) {
      const year = date.getFullYear();
      const month = date.getMonth();
      const today = new Date();
      const todayStr = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;

      const firstDay = new Date(year, month, 1).getDay();
      const lastDate = new Date(year, month + 1, 0).getDate();

      monthYear.innerText = `${date.toLocaleString('default', { month: 'long' })} ${year}`;
      calendarDays.innerHTML = "";

      for (let i = 0; i < firstDay; i++) {
        calendarDays.innerHTML += `<div></div>`;
      }

      for (let d = 1; d <= lastDate; d++) {
        const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
        let classes = [];

        if (highlightedDates.includes(dateStr)) classes.push("highlighted");
        if (dateStr === todayStr) classes.push("today");

        calendarDays.innerHTML += `<div class="${classes.join(' ')}">${d}</div>`;
      }
    }

    prevBtn.addEventListener("click", () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar(currentDate);
    });

    nextBtn.addEventListener("click", () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar(currentDate);
    });

    renderCalendar(currentDate);
  </script>
  <script>
    // Open the "Add Event" popup when the Add button is clicked
    document.querySelector('.search-bar button').addEventListener('click', () => {
        document.getElementById('addEventModal').style.display = 'flex';
    });

    function closeAddEventModal() {
        document.getElementById('addEventModal').style.display = 'none';
    }

    // Submit new event
    document.getElementById('addEventForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch("{% url 'add_event' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to add event: ' + data.error);
            }
        });
    });
</script>

<script>
    function openEditEventModal(eventId, name, venue, day, startTime, endTime, date) {
        document.getElementById("edit_event_original_id").value = eventId;
        document.getElementById("edit_event_id").value = eventId;
        document.getElementById("edit_event_name").value = name;
        document.getElementById("edit_event_venue").value = venue;
        document.getElementById("edit_event_day").value = day;
        document.getElementById("edit_event_start").value = startTime;
        document.getElementById("edit_event_end").value = endTime;
        document.getElementById("edit_event_date").value = date;

        document.getElementById("editEventModal").style.display = "flex";
    }

    function closeEditEventModal() {
        document.getElementById("editEventModal").style.display = "none";
    }

    // Attach edit event listeners
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.fa-edit').forEach(function (editIcon) {
            editIcon.addEventListener('click', function () {
                const row = editIcon.closest('tr');
                const eventId = row.children[0].textContent.trim();
                const name = row.children[1].textContent.trim();
                const venue = row.children[2].textContent.trim();
                const day = row.children[3].textContent.trim();
                const startTime = row.children[4].textContent.trim();
                const endTime = row.children[5].textContent.trim();
                const date = row.children[6].textContent.trim();

                openEditEventModal(eventId, name, venue, day, startTime, endTime, date);
            });
        });
    });
</script>

<script>
    // Submit edited event
    document.getElementById("editEventForm").addEventListener("submit", function(e) {
        e.preventDefault();

        const formData = new FormData(this);

        fetch("{% url 'update_event' %}", {
            method: "POST",
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Event updated successfully!");
                location.reload();
            } else {
                alert("Update failed: " + data.error);
            }
        })
        .catch(error => {
            alert("Error: " + error);
        });
    });
</script>

<script>
    function confirmEventDelete(eventId) {
        if (confirm("Are you sure you want to delete this event?")) {
            fetch(`/delete_event/${eventId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert("Delete failed: " + data.error);
                }
            });
        }
    }
</script>
<script>
  function deleteEvent(eventId) {
  fetch('/delete_event/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken'), // If CSRF protection enabled
    },
    body: JSON.stringify({ id: eventId })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Event deleted!');
      // Refresh calendar or event list here
    } else {
      alert('Delete failed: ' + data.error);
    }
  });
}
</script>

<script>
  // Popup open/close for Add Event
  function showPopup() {
    document.getElementById('popup').style.display = 'flex';
  }
  function hidePopup() {
    document.getElementById('popup').style.display = 'none';
  }

  // Add Event functionality - already in your code, no change needed

  // Edit Event modal open/close - already present and hooked up

  // Confirm Delete Event
  function confirmEventDelete(eventId) {
    if (confirm("Are you sure you want to delete this event?")) {
      fetch(`/delete_event/${eventId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Event deleted!');
          location.reload();
        } else {
          alert('Delete failed: ' + data.error);
        }
      });
    }
  }

  // SEARCH FUNCTIONALITY - filters rows in event table in real-time
  document.getElementById('search-event').addEventListener('input', function() {
    const query = this.value.toLowerCase();
    const rows = document.querySelectorAll('#eventTableBody tr');

    rows.forEach(row => {
      const rowText = row.textContent.toLowerCase();
      if (rowText.includes(query)) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  });

  // Attach edit event listeners to dynamically handle rows added after page load
  function attachEditListeners() {
    document.querySelectorAll('.fa-edit').forEach(editIcon => {
      editIcon.addEventListener('click', function () {
        const row = editIcon.closest('tr');
        const eventId = row.children[0].textContent.trim();
        const name = row.children[1].textContent.trim();
        const venue = row.children[2].textContent.trim();
        const day = row.children[3].textContent.trim();
        const startTime = row.children[4].textContent.trim();
        const endTime = row.children[5].textContent.trim();
        const date = row.children[6].textContent.trim();

        openEditEventModal(eventId, name, venue, day, startTime, endTime, date);
      });
    });
  }

  // Initial call
  attachEditListeners();

  // When you add new event rows dynamically, call attachEditListeners() again to bind edit clicks

</script>


</body>
</html>
